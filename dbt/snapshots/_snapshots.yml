version: 2

snapshots:
  - name: snapshot_polygon_stocks
    description: Snapshot of daily OHLCV for stock tickers from Polygon.io. Tracks historical changes over time to support SCD-style analysis.
    tags: ["snapshot", "stocks", "polygon"]
    columns:
      - name: ticker
        description: Stock ticker symbol.
        tests:
          - not_null

      - name: polygon_trade_date
        description: Trading date (UTC) for the aggregated daily bar.
        tests:
          - not_null

      - name: inserted_at
        description: Timestamp when the record was first loaded into the raw source table.

      - name: open
        description: Opening price for the day.
        tests:
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0

      - name: high
        description: Highest price for the day.
        tests:
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0

      - name: low
        description: Lowest price for the day.
        tests:
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0

      - name: close
        description: Closing price for the day.
        tests:
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0

      - name: vwap
        description: Volume-weighted average price for the day.
        tests:
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0

      - name: volume
        description: Total shares traded for the day.
        tests:
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0

      - name: transactions
        description: Number of trades contributing to the bar.
        tests:
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0

      - name: dbt_valid_from
        description: Timestamp when this snapshot row became valid.
        tests:
          - not_null

      - name: dbt_valid_to
        description: Timestamp when this snapshot row became invalid. NULL indicates the current version.

      - name: dbt_scd_id
        description: Deterministic unique identifier generated by dbt for each snapshot row.
        tests:
          - not_null

      - name: dbt_updated_at
        description: Timestamp when dbt last updated this snapshot row.

    tests:
      - dbt_expectations.expect_compound_columns_to_be_unique:
          column_list: ["ticker", "polygon_trade_date", "dbt_valid_from"]

  - name: snapshot_polygon_options
    description: Snapshot of daily OHLCV for option contracts from Polygon.io. Captures historical changes over time to support SCD-style analysis for options.
    tags: ["snapshot", "options", "polygon"]
    columns:
      - name: option_symbol
        description: OCC-formatted option contract symbol (e.g., O:GOOGL251017P00247500).
        tests:
          - not_null

      - name: polygon_trade_date
        description: Trading date (UTC) for the optionâ€™s aggregated daily bar.
        tests:
          - not_null

      - name: inserted_at
        description: Timestamp when the record was first loaded into the raw source table.

      - name: open
        description: Opening price for the day.
        tests:
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0

      - name: high
        description: Highest price for the day.
        tests:
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0

      - name: low
        description: Lowest price for the day.
        tests:
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0

      - name: close
        description: Closing price for the day.
        tests:
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0

      - name: vwap
        description: Volume-weighted average price for the day.
        tests:
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0

      - name: volume
        description: Number of option contracts traded for the day.
        tests:
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0

      - name: transactions
        description: Number of trades contributing to the bar.
        tests:
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0

      - name: dbt_valid_from
        description: Timestamp when this snapshot row became valid.
        tests:
          - not_null

      - name: dbt_valid_to
        description: Timestamp when this snapshot row became invalid. NULL indicates the current version.

      - name: dbt_scd_id
        description: Deterministic unique identifier generated by dbt for each snapshot row.
        tests:
          - not_null

      - name: dbt_updated_at
        description: Timestamp when dbt last updated this snapshot row.

    tests:
      - dbt_expectations.expect_compound_columns_to_be_unique:
          column_list: ["option_symbol", "polygon_trade_date", "dbt_valid_from"]
