version: 2

models:
  - name: int_polygon__stocks
    description: Enriches the daily stock bar data with calculated technical indicators like moving averages. This model is incremental.
    tags: ["intermediate", "stocks", "polygon"]
    columns:
      - name: stock_bar_id
        description: Unique identifier for a single day's stock bar (ticker + polygon_trade_date).
        tests:
          - unique
          - not_null

      - name: ticker
        description: Stock ticker symbol.
        tests:
          - not_null

      - name: polygon_trade_date
        description: Date of the stock bar.
        tests:
          - not_null

      - name: loaded_at
        description: Timestamp when the record was loaded into the staging layer.

      - name: open_price
        description: Opening price for the day.
        tests:
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0

      - name: high_price
        description: Highest price for the day.
        tests:
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0

      - name: low_price
        description: Lowest price for the day.
        tests:
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0

      - name: close_price
        description: Closing price for the day.
        tests:
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0

      - name: volume
        description: Trading volume for the day.
        tests:
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0

      - name: transactions
        description: Number of trades contributing to the bar.
        tests:
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0

      - name: moving_avg_20d
        description: 20-day simple moving average of the closing price.
        tests:
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0

      - name: moving_avg_50d
        description: 50-day simple moving average of the closing price.
        tests:
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0

    tests:
      - dbt_expectations.expect_compound_columns_to_be_unique:
          column_list: ["ticker", "polygon_trade_date"]

  - name: int_polygon__options
    description: Enriches daily options data with calculated metrics like days to expiration. This model is incremental.
    tags: ["intermediate", "options", "polygon"]
    columns:
      - name: option_bar_id
        description: Unique identifier for a single day's option bar.
        tests:
          - unique
          - not_null

      - name: option_symbol
        description: OCC-formatted symbol for the option contract (e.g., O:GOOGL251017P00247500).
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_match_regex:
              regex: '^O:[A-Z0-9]{1,6}\\d{6}[CP]\\d{8}$'

      - name: underlying_ticker
        description: Ticker symbol of the underlying stock.
        tests:
          - not_null

      - name: polygon_trade_date
        description: Date of the option bar.
        tests:
          - not_null

      - name: expiration_date
        description: Expiration date of the option contract.
        tests:
          - not_null

      - name: strike_price
        description: Strike price of the option contract.
        tests:
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0

      - name: option_type
        description: Type of option (call or put).
        tests:
          - accepted_values:
              values: ["call", "put"]

      - name: close_price
        description: Closing price of the option for the day.
        tests:
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0

      - name: volume
        description: Trading volume for the day.
        tests:
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0

      - name: volume_weighted_average_price
        description: Volume-weighted average price for the day.
        tests:
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0

      - name: days_to_expiration
        description: Number of days from the trade date to the optionâ€™s expiration date.
        tests:
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0

    tests:
      - dbt_expectations.expect_compound_columns_to_be_unique:
          column_list: ["option_symbol", "polygon_trade_date"]

  - name: int_polygon__stocks_options_joined
    description: Joins enriched options and stock data to create a comprehensive view for analysis. This model is incremental.
    tags: ["intermediate", "joined", "polygon"]
    columns:
      - name: option_bar_id
        description: Unique identifier for a single day's option bar.
        tests:
          - unique
          - not_null
